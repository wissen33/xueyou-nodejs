### 创建一个工程 -- 手动

```js
// 初始化项目
$ mkdir express-demo && cd express-demo
$ npm init -y
$ git init
// 创建并添加不需要上传的内容（node_modules）
$ mkdir .gitignore
// 安装依赖
$ npm i express -S
// 创建入口 src/app.js
$ mkdir src && touch app.js
```

```js
// src/app.js
const express = require("express");
// express 实例
const app = express();
const port = 3001;

app.get("/", (req, res) => {
  res.send("Hello World!");
});

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```

```js
// 设置自动重启
$ npm i nodemon -D
$ npm start
```

```js
// 修改脚本 package.json
{
  "name": "express-demo",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "start": "nodemon ./src/app.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "express": "^4.17.3"
  },
  "devDependencies": {
    "nodemon": "^2.0.15"
  }
}
```

### 创建一个工程 -- 脚手架

```js
// 安装环境
$ npm install express -g    // web应用开发框架
$ npm install express-generator -g  // 安装express脚手架
```

```js
$ express myapp    // 创建出来的是jade模板
     express -e myapp     // ejs模板-适合前端
$ cd myapp && npm install     // 下载依赖
$ npm start    // 以package.json创建这个脚本
// 修改及重启node服务
$ npm i -g node-dev，在package.json里改成node-dev ./bin/www就可以自动重启服务器了
```

#### Features

让我们快速上手并可以更加简洁更加方便的写出一个 http 服务

- Robust routing: 健壮的路由系统
- Focus on high performance: (设计思路、并不是功能点) 专注高性能、功能和性能的取舍上选择了性能
- Super-high test coverage: (设计思路、并不是功能点) 广泛的测试覆盖率
- HTTP helpers (redirection, caching, etc): 帮你处理 http 请求能力、快速处理 302、304 等
- View system supporting 14+ template engines: 支持 14 多种模版引擎
- Content negotiation: 帮你处理 http 请求能力、快速处理 accept 头不内容
- Executable for generating applications quickly: 提供了一些列的脚手架

#### 核心功能

- 路由
- request/response 简化
  --request: pathName、query 等
  --response: send()、json()、jsonp()等

### 路由

可以把路由理解成就是规则

#### 如何处理请求

1. 请求方法的区分

get post delete put 等等

2. uri 区分

www.baidu.com/a/a/a.html -- a/a/a 就是 uri 也就是路径

#### 二级路由

```js
// app.js
var indexRouter = require("./routes/index");
app.use("/", indexRouter); // 注册斜杠这个路由
```

```js
// routes/index.js
router.get("/", function (req, res, next) {
  // 这个斜杠是二级路由
  res.render("index", { title: "Express" }); // 渲染index.ejs模板到浏览器中
});

router.get("/a", function (req, res, next) {
  // 这个斜杠是二级路由
  res.render("error", { title: "Express" }); // 渲染error.ejs模板到浏览器中
});

router.post("/a", function (req, res, next) {
  // 上面方法的post请求
  res.render("error", { title: "Express" }); // 渲染error.ejs模板到浏览器中
});
```

#### 解析 url 参数

```js
// postman 调用 127.0.0.1:3001/home?id = 123
app.get("/home", (req, res) => {
  let { id } = req.params;
  res.json({
    tag: "test",
    id,
  });
});
```

#### 支持全部请求

需要定义一个 api/路由 需要满足 所有请求 （get/post/delete/put），都可以响应

```js
// postman 调用 127.0.0.1:3001/test ，无论什么请求都可以
app.all("/test", (req, res) => {
  res.json({
    message: "test",
    method: req.method,
  });
});
```

```js
// 通过 use 也可以实现这个需求
app.use("/test", (req, res) => {
  res.json({
    message: "test",
    method: req.method,
  });
});
```

```js
// 为 星 的时候，无论路径是什么都可以有响应，上面指针对 /test 路径
app.all("*", (req, res) => {
  res.json({
    message: "test",
    method: req.method,
  });
});
```

```js
// 通过 use 也可以实现上面的需求
app.use((req, res) => {
  res.json({
    message: "test",
    method: req.method,
  });
});
```

#### 路由的拆分

- postman 调用 127.0.0.1:3001/sku/list
- postman 调用 127.0.0.1:3001/member/list

```js
// app.js
const express = require("express");
// express 实例
const app = express();
const port = 3001;

// 路由也是中间件，所以可以用use注册
const memberRouter = require("./member.router");
const skuRouter = require("./sku.router");

// 注册路由
app.use("/member", memberRouter);
app.use("/sku", skuRouter);

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```

```js
// member.router.js
const express = require("express");

const router = express.Router(); // 可以理解成是 app 的子对象

// 成员列表，正常是需要分页的
router.get("/list", (req, res) => {
  res.json({
    list: [
      {
        id: 0001,
        name: "王子",
      },
    ],
  });
});

// router.all() post delete
// router.use  这里面也可以进行切割，但是不要划分太多，否则难以维护

module.exports = router; //一个nodejs的模块，需要暴露出去，在入口需要注册
```

```js
// sku.router.js
const express = require("express");

const router = express.Router(); // 可以理解成是 app 的子对象

// 订单列表，正常是需要分页的
router.get("/list", (req, res) => {
  res.json({
    list: [
      {
        id: 0001,
        price: 100,
        name: "鞋子",
      },
    ],
  });
});

// router.all() post delete
// router.use  这里面也可以进行切割，但是不要划分太多，否则难以维护

module.exports = router; //一个nodejs的模块，需要暴露出去，在入口需要注册
```

### 中间件

中间件是一个可插拔的功能

#### 中间件结构

1. 是一个函数

2. err,req,res,next(function)

```js
function demo_middleware(err, req, res, next) {
  // 中间件能干的事情
  // 1. 异常处理
  // 2. 处理业务功能，然后转交控制权
  // 3. 响应请求 -- 结束响应 -- 当作路由的处理函数（其实路由也是中间件的一种）
}
```

#### 中间件路由前置

下面只有当通过 `app.use("*")` 的检测后，才能达到 `/test` 的处理

```js
const express = require("express");
const res = require("express/lib/response");
// express 实例
const app = express();
const port = 3001;

// 路由也是中间件，所以可以用use注册
const memberRouter = require("./member.router");
const skuRouter = require("./sku.router");

// /test?name=xiaowang
function valid_name_middleware(req, res, next) {
  let { name } = req.query;
  if (!name) {
    res.json({
      message: "缺少name参数",
    });
  } else {
    next();
  }
}

app.all("*", valid_name_middleware);

app.get("/test", (req, res) => {
  res.json({
    message: "成功了",
  });
});

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```

#### 中间件级别

1. app 级别的使用

- 注册的时候，一定是在最顶级，实例话之后立即注册
- 声明方式 app.use

2. router 级别的使用
3. 异常处理 -- app 级别 -- router 级别 -- 根据场景有关系

#### 使用方法

```js
const express = require("express");
const res = require("express/lib/response");
// express 实例
const app = express();
const port = 3001;

function log_middleware() {
  console.log("有请求。。。");
}

app.use("*", log_middleware);

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```

```js
// 静态资源的使用
// 加载一个 static 的中间件
// 创建 static/index.html
// postman 调用 127.0.0.1:3001/index.html

app.use(express.static("static", {}));
```

```js
// 通过第二个参数，经历一系列的中间件处理，最后调用回调函数
router.get(
  "/list",
  [
    /** middleware*/
  ],
  (req, res) => {
    res.json({
      list: [
        {
          id: 0001,
          price: 100,
          name: "鞋子",
        },
      ],
    });
  }
);
```

中间件传惨给下一步

```js
// postman 调用 127.0.0.1:3001/test?name=123&password=222

const express = require("express");
const res = require("express/lib/response");
// express 实例
const app = express();
const port = 3001;

function log_middleware(req, res, next) {
  let { name, password } = req.query;
  if (!name || !password) {
    res.json({
      message: "账号密码不对",
    });
  } else {
    req.formData = {
      name,
      password,
    };
    next();
  }
}

app.get("/test", [log_middleware], (req, res, next) => {
  let { formData } = req;
  res.json({
    formData,
    message: "成功",
  });
});

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```

### 相关网址

https://www.npmjs.com/package/express

http://expressjs.com/en/4x/api.html#express
